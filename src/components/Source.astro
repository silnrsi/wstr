---
// Source component: display a source
// Used by TaggedSources - and eventually a lot more!
// Parameters:
//     key: source Key field

// Types to handle: @article, @book, @inbook, @inproceedings, @online, @misc

const { key } = Astro.props;

// Eventually use the SQL DB:
//import { getCollection } from 'astro:content';
//const allSources = await getCollection('sources');

import sdata from '../data/sources.json';

let sObj = sdata.find((s) => s.Key == key);

const stype = sObj?.EntryType;

let authorString = sObj?.Author ?? '';
let editorString = sObj?.Editor ?? '';
if (authorString === '' && editorString !== '') {
	if (editorString.includes(' and ')) {
		authorString = `${editorString}, eds.`;
	} else {
		authorString = `${editorString}, ed.`;
	}
	editorString = ``;
} else if (editorString !== '') {
	editorString = `edited by ${editorString}`;
}

// Only one of these will exist:
let largerWork = (sObj?.JournalTitle ?? '') + (sObj?.BookTitle ?? '');

let seriesString = sObj?.Series ?? '';

let volumeString = sObj?.Volume ?? '';
if (volumeString !== '') {
	volumeString = `vol. ${volumeString}`;
}
let numberString = sObj?.Number ?? '';
if (numberString !== '') {
	numberString = `no. ${numberString}`;
}

let pubString = sObj?.Publisher ?? '';
let dateString = sObj?.Date ?? '';

let pageString = sObj?.Page ?? '';
if (pageString !== '') {
	if (pageString?.includes('-')) {
		pageString = `pp. ${pageString}`;
	} else {
		pageString = `p. ${pageString}`;
	}
}

---

	{	sObj ? (
			<span>
				<!-- First sequence: web site, author title  -->

				{ (stype ==='@online' && sObj.PreSort && sObj.PreSort != ""
						&& sObj.Organization && sObj.Organization !== '' ) ? (
					<>{sObj.Organization}: </>
				  ) : null
				}

				{ (authorString !== '') ? (
					<>{authorString}, </>
				  ) : null
				}

				<!-- Title - there should always be one! -->
				{stype === '@book' ? (
					<em>{sObj.Title}. </em>
				) : (stype === '@inbook' || stype === '@article' || stype === '@inproceedings') ? (
					<>&ldquo;{sObj.Title}.&rdquo; </>
				) : (stype === '@online' && sObj.Url && sObj.Url !== '' ) ? (
					<>&ldquo;<a href={sObj.Url} target="_blank" rel="noopener noreferrer">{sObj.Title}</a>.&rdquo; </>
				) : (
					<>&ldquo;{sObj.Title}.&rdquo; </>
					)
				}

				<!-- Second sequence -->

				{	( largerWork != "" ) ? ( 
					<><em>{largerWork}</em>
					{	(editorString !== '' || volumeString !== '' || numberString !== '' || pubString !== '' 
									|| dateString !== '' || pageString !== '') ? (
							<>, </>
						) : null
					}
					</>
					) : null
				}
				<!-- Alternative to largerWork: -->
				{	( seriesString != "" ) ? (
					<>{seriesString}
					{	(editorString !== '' || volumeString !== '' || numberString !== '' || pubString !== '' 
									|| dateString !== '' || pageString !== '') ? (
							<>, </>
						) : null
					}
					</>
					) : null
				}

				{	( editorString !== '' ) ? ( 
					<>{editorString}
					{	(volumeString !== '' || numberString !== '' || pubString !== '' 
								|| dateString !== '' || pageString !== '') ? (
							<>, </>
						) : null
					}
					</>
					)	: null
				}

				{	( volumeString !== "" ) ? (
					<>{volumeString}
					
					{	(numberString !== '' || pubString !== '' || dateString !== '' || pageString !== '') ? (
							<>, </>
						)	: null
					}
					</>	) : null
				}

				{	( numberString !== '' ) ? (
					<>{numberString}
					{	(pubString !== '' || dateString !== '' || pageString !== '') ? (
							<>, </>
						)	: null
					}
					</>	) : null
				}

				{	( pubString !== '' ) ? (
					<>{pubString}
					{	(dateString !== '' || pageString !== '') ? (
							<>, </>
						)	: null
					}			
					</>	) : null
				}

				{	( dateString !== "" ) ? (
					<>{dateString}
					{	(pageString !== '') ? (
							<>, </>
						)	: null
					}	
					</>	) : null
				}

				{	( pageString !== "" ) ? ( <>{pageString}</>	) : null }

				{	(largerWork !== '' || editorString !== '' || volumeString !== '' || numberString !== '' 
								|| pubString !== '' || dateString !== '' || pageString !== '') ? (
						<>.</>
					)	: null
				}


				<!-- Last-accessed date -->
				{ (sObj.UrlDate && sObj.UrlDate != "") ? (
					<> Accessed {sObj.UrlDate}.</span>
					) : null
				}
			</span>
		) : null 
	}
