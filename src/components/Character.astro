---
// Character component
// Display a Unicode character with its Unicode Scalar Value and name
// The character is displayed as a string, the USV as a hexadecimal number, and the name in small caps
//
// Syntax:
// See https://writingsystems.info/reference/component-reference/#character-component

import { AstroError } from 'astro/errors';
import { type Option, htmlFromCharacter, htmlFromUSV, parseOptionsSequence } from '../plugins/character.mts';

function throwComponentError(name: string, message: string, hint?: string) {
    var err = new AstroError(message, hint)
    err.name = name
    Error.captureStackTrace(err, Astro.self)
    throw err
}

interface Props {
  usv?: string;
  char?: string;
  options?: Option[];
}

let {
  usv,
  char,
  options = ['usv', 'char', 'name']
} = Astro.props

// Check that either usv or char is provided
if (!(usv || char)) {
  throwComponentError('CharacterComponentAttributeError', 
    'Missing component attribute', 
    'Character component requires either "usv" or "char" attribute.')
}

// Parse the options string.
if (typeof options === 'string') {
  try {
    options = parseOptionsSequence(options)
  } catch (error) {
    throwComponentError((error as Error).name, 'Invalid component attribute', (error as Error).message)
  }
}

let html
try {
  const opts = Object.fromEntries(options.map((k:Option) => [k,true]))
  if (usv) {
    html = htmlFromUSV(usv, opts)
  } else if (char) {
    html = htmlFromCharacter(char, opts)
  }
} catch (error) {
  throwComponentError((error as Error).name, 'Internal error', (error as Error).message)
}
---
<Fragment set:html={html} />